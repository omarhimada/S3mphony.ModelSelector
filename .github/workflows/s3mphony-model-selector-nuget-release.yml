name: NuGet Package Workflow

on:
  push:
    branches: [ "master" ]

jobs:
  create_nuget:
    name: Create NuGet Package
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore ./S3mphony.ModelSelector.slnx

      - name: Build (Release)
        run: dotnet build ./S3mphony.ModelSelector.csproj --configuration Release --no-restore

      - name: Pack to artifacts folder
        shell: pwsh
        run: |
          $version = [DateTime]::UtcNow.ToString("yyyy.MM.dd.HHmm")
          New-Item -ItemType Directory -Force -Path "./artifacts/nuget" | Out-Null
          dotnet pack ./S3mphony.ModelSelector.csproj `
            --configuration Release `
            --no-build `
            -p:PackageVersion=$version `
            -o "./artifacts/nuget"

      - name: Upload NuGet artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget
          path: ./artifacts/nuget/*.nupkg
          if-no-files-found: error
          retention-days: 7

  deploy:
    name: Deploy NuGet
    runs-on: windows-latest
    needs: create_nuget
    if: success()

    steps:
      - name: Setup .NET (for dotnet nuget push)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Download NuGet artifact
        uses: actions/download-artifact@v4
        with:
          name: nuget
          path: ./artifacts/nuget

      - name: Publish to nuget.org
        shell: pwsh
        run: |
          $pkgs = Get-ChildItem "./artifacts/nuget" -Filter *.nupkg -File
          if (-not $pkgs) { throw "No .nupkg files found in ./artifacts/nuget" }

          foreach ($pkg in $pkgs) {
            dotnet nuget push "$($pkg.FullName)" `
              --api-key "${{ secrets.NUGET_APIKEY }}" `
              --source "https://api.nuget.org/v3/index.json" `
              --skip-duplicate
          }

